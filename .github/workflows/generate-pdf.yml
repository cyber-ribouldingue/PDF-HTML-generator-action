name: Generate PDF with Pandoc

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: write  # Donne la permission de modifier les fichiers dans le dépôt

jobs:
  generate-pdf:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Check if input file exists
      run: |
        if [ ! -f input.md ]; then
          echo "Error: input.md is missing!"
          exit 1
        fi

    - name: Install Pandoc and LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc texlive texlive-latex-extra texlive-fonts-recommended

    - name: Generate PDF
      run: |
        mkdir -p output
        pandoc input.md -o output/output.pdf

    - name: Add the PDF to the repository
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add output/output.pdf
        git commit -m "Add generated PDF" || echo "No changes to commit"

    - name: Push PDF to repository
      run: |
        git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main

    - name: Update README with PDF link
      run: |
        # Vérifier si le fichier README.md existe avant de le modifier
        if [ -f README.md ]; then
          echo "# Generated PDF" > README.md
          echo "[Download the generated PDF](output/output.pdf)" >> README.md
          git add README.md
          git commit -m "Update README with PDF link" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
        else
          echo "README.md does not exist, skipping update."
        fi
